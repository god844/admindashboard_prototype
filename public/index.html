<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes blob {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }
    .animate-blob {
      animation: blob 7s infinite;
    }
    .animation-delay-2000 {
      animation-delay: 2s;
    }
    .animation-delay-4000 {
      animation-delay: 4s;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
  <div class="fixed inset-0 overflow-hidden pointer-events-none opacity-20">
    <div class="absolute w-96 h-96 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
    <div class="absolute right-0 w-96 h-96 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
    <div class="absolute bottom-0 left-20 w-96 h-96 bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-4000"></div>
  </div>

  <div class="max-w-7xl mx-auto p-6 relative z-10">
    <!-- Header -->
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-8 mb-6 border border-blue-100 shadow-lg">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
        ğŸ“Š Admin Dashboard
      </h1>
      <p class="text-gray-600">Professional Data Management System</p>
      <div id="notification-area" class="mt-4"></div>
    </div>

    <!-- Tabs -->
    <div class="bg-white/90 backdrop-blur-sm rounded-xl p-2 mb-6 border border-blue-100 flex gap-2 shadow-lg flex-wrap">
      <button onclick="showTab('upload')" class="tab-btn flex-1 min-w-[140px] py-3 px-6 rounded-lg font-semibold transition-all duration-300" data-tab="upload">
        ğŸ“¤ Upload
      </button>
      <button onclick="showTab('data')" class="tab-btn flex-1 min-w-[140px] py-3 px-6 rounded-lg font-semibold transition-all duration-300" data-tab="data">
        ğŸ—‚ï¸ Data
      </button>
      <button onclick="showTab('schools')" class="tab-btn flex-1 min-w-[140px] py-3 px-6 rounded-lg font-semibold transition-all duration-300" data-tab="schools">
        ğŸ« Schools
      </button>
      <button onclick="showTab('columns')" class="tab-btn flex-1 min-w-[140px] py-3 px-6 rounded-lg font-semibold transition-all duration-300" data-tab="columns">
        âš™ï¸ Columns
      </button>
    </div>

    <!-- Content -->
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-8 border border-blue-100 shadow-lg">
      
      <!-- Upload Tab -->
      <div id="upload-tab" class="tab-content">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Upload Excel Data</h2>
        <div class="border-4 border-dashed border-blue-300 rounded-xl p-12 text-center hover:border-blue-400 transition-all bg-blue-50/50">
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event)">
          <label for="fileInput" class="cursor-pointer">
            <div class="text-6xl mb-4">ğŸ“</div>
            <p class="text-xl text-gray-700 mb-2">Drop your Excel file here or click to browse</p>
            <p class="text-gray-500">Supports .xlsx, .xls, .csv formats</p>
          </label>
        </div>
        <div class="text-gray-600 bg-blue-50/70 p-4 rounded-lg border border-blue-200 mt-6">
          <p class="font-semibold text-lg">ğŸ“Š Total Records: <span id="record-count">0</span></p>
          <p class="text-sm mt-2">ğŸ’¡ Columns are automatically detected from your Excel file</p>
        </div>
      </div>

      <!-- Data Tab -->
      <div id="data-tab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
          <h2 class="text-2xl font-bold text-gray-800">View & Filter Data</h2>
          <div class="flex gap-3">
            <button onclick="clearFilters()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200 border border-gray-300">
              âŒ Clear Filters
            </button>
            <button onclick="downloadFiltered()" class="flex items-center gap-2 bg-gradient-to-r from-emerald-400 to-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:scale-105 transition-transform shadow-md">
              â¬‡ï¸ Download Filtered
            </button>
          </div>
        </div>

        <div class="bg-blue-50/70 rounded-xl p-6 border border-blue-200 mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ” Advanced Filters</h3>
          <div id="filter-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Filters will be generated here -->
          </div>
        </div>

        <div class="overflow-x-auto rounded-xl border border-blue-200 shadow-md">
          <table class="w-full" id="data-table">
            <thead class="bg-gradient-to-r from-blue-100 to-purple-100">
              <tr id="table-header"></tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center text-gray-600 bg-blue-50/70 p-4 rounded-lg border border-blue-200 mt-4">
          <span id="record-info">Showing 0 of 0 records</span>
          <span class="text-sm">ğŸ’¡ Download exports only filtered data</span>
        </div>
      </div>

      <!-- Schools Tab -->
      <div id="schools-tab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
          <h2 class="text-2xl font-bold text-gray-800">School Management</h2>
          <input type="text" id="school-search" placeholder="ğŸ” Search schools..." 
            class="px-4 py-2 bg-blue-50 border border-blue-300 rounded-lg text-gray-700"
            oninput="filterSchools()">
        </div>

        <div class="bg-blue-50/70 rounded-xl p-6 border border-blue-200 mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New School</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
            <input type="text" id="new-school-name" placeholder="School Name" class="bg-white border border-blue-300 rounded-lg px-4 py-2">
            <select id="new-school-status" class="bg-white border border-blue-300 rounded-lg px-4 py-2">
              <option value="pending">Pending</option>
              <option value="started">Started</option>
              <option value="completed">Completed</option>
            </select>
            <input type="date" id="new-school-start" class="bg-white border border-blue-300 rounded-lg px-4 py-2">
            <input type="date" id="new-school-deadline" class="bg-white border border-blue-300 rounded-lg px-4 py-2">
            <input type="number" id="new-school-priority" placeholder="Priority" min="1" value="1" class="bg-white border border-blue-300 rounded-lg px-4 py-2">
            <button onclick="addSchool()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-2 rounded-lg font-semibold hover:scale-105 transition-transform shadow-md">
              â• Add
            </button>
          </div>
        </div>

        <div id="schools-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Schools will be rendered here -->
        </div>
      </div>

      <!-- Columns Tab -->
      <div id="columns-tab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Database Columns</h2>
        
        <div class="bg-blue-50/70 rounded-xl p-6 border border-blue-200 mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New Column</h3>
          <div class="flex gap-4">
            <input type="text" id="new-column" placeholder="Column name..." class="flex-1 bg-white border border-blue-300 rounded-lg px-4 py-2">
            <button onclick="addColumn()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-2 rounded-lg font-semibold hover:scale-105 transition-transform shadow-md">
              â• Add Column
            </button>
          </div>
        </div>

        <div id="columns-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Columns will be rendered here -->
        </div>
      </div>

    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let allData = [];
    let filteredData = [];
    let columns = [];
    let schools = [];
    let filters = {};

    // Initialize with sample data
    async function init() {
      await fetchColumns();
      await fetchData();
      await fetchSchools();
      showTab('upload');
      updateRecordCount();
    }

    // Fetch functions
    async function fetchColumns() {
      try {
        const response = await fetch(`${API_URL}/api/columns`);
        const data = await response.json();
        columns = data.map(col => col.column_name);
        renderColumns();
      } catch (error) {
        console.error('Error fetching columns:', error);
      }
    }

    async function fetchData() {
      try {
        const response = await fetch(`${API_URL}/api/data`);
        allData = await response.json();
        filteredData = [...allData];
        renderTable();
        renderFilters();
        updateRecordCount();
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    async function fetchSchools() {
      try {
        const response = await fetch(`${API_URL}/api/schools`);
        schools = await response.json();
        renderSchools();
      } catch (error) {
        console.error('Error fetching schools:', error);
      }
    }

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-purple-500', 'text-white', 'shadow-md', 'scale-105');
          btn.classList.remove('text-gray-600', 'hover:bg-blue-50');
        } else {
          btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-500', 'text-white', 'shadow-md', 'scale-105');
          btn.classList.add('text-gray-600', 'hover:bg-blue-50');
        }
      });
    }

    // File upload
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(`${API_URL}/api/upload`, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        alert(`âœ… Successfully uploaded ${result.count} records!`);
        await fetchColumns();
        await fetchData();
      } catch (error) {
        alert('âŒ Error uploading file: ' + error.message);
      }
    }

    // Render table
    function renderTable() {
      const headerRow = document.getElementById('table-header');
      const tbody = document.getElementById('table-body');
      
      headerRow.innerHTML = columns.map(col => 
        `<th class="px-6 py-4 text-left text-gray-700 font-semibold capitalize">${col}</th>`
      ).join('');

      tbody.innerHTML = filteredData.map(row => 
        `<tr class="border-t border-blue-100 hover:bg-blue-50/50 transition-colors">
          ${columns.map(col => `<td class="px-6 py-4 text-gray-600">${row[col] || '-'}</td>`).join('')}
        </tr>`
      ).join('');

      document.getElementById('record-info').textContent = 
        `Showing ${filteredData.length} of ${allData.length} records`;
    }

    // Render filters
    function renderFilters() {
      const filterArea = document.getElementById('filter-area');
      const categoricalCols = ['grade', 'subject', 'status', 'school'];
      
      filterArea.innerHTML = columns.map(col => {
        const isSelect = categoricalCols.includes(col);
        const uniqueValues = [...new Set(allData.map(row => row[col]).filter(Boolean))];
        
        if (isSelect) {
          return `
            <div class="bg-white rounded-lg p-4 border border-blue-200">
              <label class="text-gray-700 text-sm font-semibold mb-2 block capitalize">${col} (Select)</label>
              <select class="w-full bg-blue-50 border border-blue-300 rounded-lg px-3 py-2" onchange="applyFilter('${col}', this.value)">
                <option value="">All ${col}</option>
                ${uniqueValues.map(val => `<option value="${val}">${val}</option>`).join('')}
              </select>
            </div>
          `;
        } else {
          return `
            <div class="bg-white rounded-lg p-4 border border-blue-200">
              <label class="text-gray-700 text-sm font-semibold mb-2 block capitalize">${col} (Text)</label>
              <input type="text" placeholder="Search ${col}..." 
                class="w-full bg-blue-50 border border-blue-300 rounded-lg px-3 py-2" 
                oninput="applyFilter('${col}', this.value)">
            </div>
          `;
        }
      }).join('');
    }

    // Apply filters
    function applyFilter(column, value) {
      if (value) {
        filters[column] = value;
      } else {
        delete filters[column];
      }
      
      filteredData = allData.filter(row => {
        return Object.keys(filters).every(key => {
          const filterValue = filters[key].toLowerCase();
          const rowValue = (row[key] || '').toString().toLowerCase();
          return rowValue.includes(filterValue);
        });
      });
      
      renderTable();
    }

    function clearFilters() {
      filters = {};
      filteredData = [...allData];
      renderTable();
      renderFilters();
    }

    // Download filtered data
    function downloadFiltered() {
      const csv = [
        columns.join(','),
        ...filteredData.map(row => columns.map(col => row[col] || '').join(','))
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `filtered_data_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }

    // Schools management
    async function addSchool() {
      const name = document.getElementById('new-school-name').value;
      if (!name) return alert('Please enter school name');

      const school = {
        name,
        status: document.getElementById('new-school-status').value,
        start_date: document.getElementById('new-school-start').value,
        deadline: document.getElementById('new-school-deadline').value,
        priority: parseInt(document.getElementById('new-school-priority').value)
      };

      try {
        await fetch(`${API_URL}/api/schools`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(school)
        });
        document.getElementById('new-school-name').value = '';
        document.getElementById('new-school-start').value = '';
        document.getElementById('new-school-deadline').value = '';
        await fetchSchools();
      } catch (error) {
        alert('Error adding school: ' + error.message);
      }
    }

    async function deleteSchool(id) {
      if (!confirm('Delete this school?')) return;
      try {
        await fetch(`${API_URL}/api/schools/${id}`, { method: 'DELETE' });
        await fetchSchools();
      } catch (error) {
        alert('Error deleting school');
      }
    }

    function renderSchools() {
      const grid = document.getElementById('schools-grid');
      const searchTerm = (document.getElementById('school-search')?.value || '').toLowerCase();
      const filtered = schools.filter(s => s.name.toLowerCase().includes(searchTerm));
      
      grid.innerHTML = filtered.map(school => {
        const statusColors = {
          completed: 'from-emerald-300 to-teal-400',
          started: 'from-sky-300 to-blue-400',
          pending: 'from-amber-300 to-orange-400'
        };
        
        return `
          <div class="bg-white rounded-xl p-6 border border-blue-200 hover:shadow-lg transition-all">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r ${statusColors[school.status]} text-white font-semibold mb-4">
              ${school.status.toUpperCase()}
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-3">${school.name}</h3>
            <div class="space-y-2 text-gray-600 mb-4">
              <p class="text-sm">Priority: ${school.priority}</p>
              ${school.start_date ? `<p class="text-sm">ğŸ“… Start: ${new Date(school.start_date).toLocaleDateString()}</p>` : ''}
              ${school.deadline ? `<p class="text-sm">â° Deadline: ${new Date(school.deadline).toLocaleDateString()}</p>` : ''}
            </div>
            <button onclick="deleteSchool(${school.id})" class="w-full px-4 py-2 bg-rose-100 text-rose-600 rounded-lg hover:bg-rose-200">
              ğŸ—‘ï¸ Delete
            </button>
          </div>
        `;
      }).join('');
    }

    function filterSchools() {
      renderSchools();
    }

    // Columns management
    async function addColumn() {
      const name = document.getElementById('new-column').value;
      if (!name) return;

      try {
        await fetch(`${API_URL}/api/columns`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ column_name: name })
        });
        document.getElementById('new-column').value = '';
        await fetchColumns();
      } catch (error) {
        alert('Error adding column');
      }
    }

    async function deleteColumn(name) {
      try {
        await fetch(`${API_URL}/api/columns/${name}`, { method: 'DELETE' });
        await fetchColumns();
      } catch (error) {
        alert('Error deleting column');
      }
    }

    function renderColumns() {
      const grid = document.getElementById('columns-grid');
      const coreColumns = ['id', 'name', 'email'];
      
      grid.innerHTML = columns.map(col => `
        <div class="bg-white rounded-lg p-4 border border-blue-200 flex items-center justify-between hover:shadow-md transition-shadow">
          <span class="text-gray-700 font-semibold capitalize">${col}</span>
          ${!coreColumns.includes(col) ? 
            `<button onclick="deleteColumn('${col}')" class="text-rose-500 hover:text-rose-600 text-xl">âŒ</button>` : 
            ''}
        </div>
      `).join('');
    }

    function updateRecordCount() {
      document.getElementById('record-count').textContent = allData.length;
    }

    // Initialize on load
    window.addEventListener('load', init);
  </script>
</body>
</html>
